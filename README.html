<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>The purpose of this analysis is to make statistically valid statements such as, <em>&ldquo;there was a significant linear decrease in the prevalence of ever smoking a cigarette across the period 1999-2011&rdquo;</em> with complex sample survey data.</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: #990073
   }

   pre .number {
     color: #099;
   }

   pre .comment {
     color: #998;
     font-style: italic
   }

   pre .keyword {
     color: #900;
     font-weight: bold
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: #d14;
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre class="r-output"><code class="r-output">"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>



<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<p>guest post by my friend <a href="mailto:thomasyokota@gmail.com">thomas yakota</a>, an oahu-based epidemiologist.  palmero professor <a href="mailto:vito.muggeo@unipa.it">vito muggeo</a> wrote the joinpoint analysis section of the code below to demonstrate that <a href="https://cran.r-project.org/web/packages/segmented/index.html">the <code>segmented</code> package</a> eliminates the need for <a href="http://surveillance.cancer.gov/joinpoint/download.html">external (registration-only, windows-only, workflow-disrupting) software</a>.  <a href="http://r-survey.r-forge.r-project.org/survey/"><code>survey</code> package</a> creator and professor <a href="t.lumley@auckland.ac.nz">thomas lumley</a> wrote <a href="https://gist.github.com/tslumley/2e74cd0ac12a671d2724">the <code>svypredmarg</code> function</a> for us to replicate SUDAAN&#39;s <code>PREDMARG</code> command and match the cdc to the decimal.  <a href="mailto:rxl1@cdc.gov">richard lowry, m.d.</a> at the centers for disease control &amp; prevention wrote <a href="http://www.cdc.gov/healthyyouth/yrbs/pdf/yrbs_conducting_trend_analyses.pdf">the original linear trend analysis</a> and then answered our infinite questions.  thanks to everyone.</p>

<hr/>

<p>&nbsp;  </p>

<h4>The purpose of this analysis is to make statistically valid statements such as, <em>&ldquo;there was a significant linear decrease in the prevalence of ever smoking a cigarette across the period 1999-2011&rdquo;</em> with complex sample survey data.</h4>

<p>This step-by-step walkthrough exactly reproduces the statistics presented in the <a href="http://www.cdc.gov/healthyyouth/yrbs/pdf/yrbs_conducting_trend_analyses.pdf">Center for Disease Control &amp; Prevention&#39;s (CDC) linear trend analysis</a>, using free and open source methods rather than proprietary or restricted software.</p>

<p>The example below displays only linearized designs (created with <a href="http://r-survey.r-forge.r-project.org/survey/html/svydesign.html">the <code>svydesign</code> function</a>).  For more detail about how to reproduce this analysis with a replicate-weighted design (created with <a href="http://r-survey.r-forge.r-project.org/survey/html/svrepdesign.html">the <code>svrepdesign</code> function</a>), see the methods note below section #4.</p>

<hr/>

<p>&nbsp;  </p>

<h3>(1) Data Importation</h3>

<p>Prior to running this analysis script, the Youth Risk Behavioral Surveillance System (YRBSS) 1991-2011 single-year files must all be loaded as r data files (.rda) on your local machine.  Running the download automation script will create the appropriate files.  If you need assistance with the data-loading step, first review <a href="http://www.asdfree.com/search/label/youth%20risk%20behavior%20surveillance%20system%20%28yrbss%29">the main YRBSS blog post</a>.</p>

<pre class="language-r"><code class="language-r"># setInternet2( FALSE )     # # only windows users need this line
# library(downloader)
# setwd( &quot;C:/My Directory/YRBSS/&quot; )
# source_url( &quot;https://raw.github.com/ajdamico/asdfree/master/Youth%20Risk%20Behavior%20Surveillance%20System/download%20all%20microdata.R&quot; , prompt = FALSE , echo = TRUE )
</code></pre>

<hr/>

<p>&nbsp;  </p>

<h3>(2) Load Required Packages, Options, External Functions</h3>

<pre class="language-r"><code class="language-r"># remove the # in order to run this install.packages line only once
# install.packages( c( &quot;segmented&quot; , &quot;downloader&quot; , &quot;plyr&quot; , &quot;survey&quot; , &quot;ggplot2&quot; , &quot;ggthemes&quot; , &quot;texreg&quot; ) )

# Muggeo V. (2008) Segmented: an R package to fit regression models with broken-line relationships. R News, 8, 1: 20-25.
library(segmented)  # determine segmented relationships in regression models

library(downloader) # downloads and then runs the source() function on scripts from github
library(plyr)       # contains the rbind.fill() function, which stacks two data frames even if they don&#39;t contain the same columns.  the rbind() function does not do this
library(survey)     # load survey package (analyzes complex design surveys)
library(ggplot2)    # load ggplot2 package (plots data according to the grammar of graphics)
library(ggthemes)   # load extra themes, scales, and geoms for ggplot2
library(texreg)     # converts output to latex tables       

# set R to produce conservative standard errors instead of crashing
# http://r-survey.r-forge.r-project.org/survey/exmample-lonely.html
options( survey.lonely.psu = &quot;adjust&quot; )
# this setting matches the MISSUNIT option in SUDAAN
# SAS uses &quot;remove&quot; instead of &quot;adjust&quot; by default,
# the table target replication was generated with SAS,
# so if you want to get closer to that, use &quot;remove&quot;


# load dr. thomas lumley&#39;s `svypremeans` function, which replicates SUDAAN&#39;s PREDMARG command
source_url( &quot;https://gist.githubusercontent.com/tslumley/2e74cd0ac12a671d2724/raw/0f5feeb68118920532f5b7d67926ec5621d48975/svypredmeans.R&quot; , prompt = FALSE , quiet = TRUE )
# for more detail about this method, see https://gist.github.com/tslumley/2e74cd0ac12a671d2724
</code></pre>

<hr/>

<p>&nbsp;  </p>

<h3>(3) Harmonize and Stack Multiple Years of Survey Data</h3>

<p>This step is clearly dataset-specific.  In order for your trend analysis to work, you&#39;ll need to figure out how to align the variables from multiple years of data into a single, stacked <code>data.frame</code> object.</p>

<pre class="language-r"><code class="language-r"># initiate an empty `y` object
y &lt;- NULL

# loop through each year of YRBSS microdata
for ( year in seq( 1991 , 2011 , 2 ) ){

    # load the current year
    load( paste0( &quot;yrbs&quot; , year , &quot;.rda&quot; ) )

    # tack on a `year` column
    x$year &lt;- year

    # stack that year of data alongside the others,
    # ignoring mis-matching columns
    y &lt;- rbind.fill( x , y )

    # clear the single-year of microdata from RAM
    rm( x )

}

# remove all unnecessary columns from the 1991-2011 multi-year stack
y &lt;- y[ c( &quot;q2&quot; , &quot;q3&quot; , &quot;q4&quot; , &quot;q23&quot; , &quot;q26&quot; , &quot;q27&quot; , &quot;q28&quot; , &quot;q29&quot; , &quot;year&quot; , &quot;psu&quot; , &quot;stratum&quot; , &quot;weight&quot; , &quot;raceeth&quot; ) ]

# convert every column to numeric type
y[ , ] &lt;- sapply( y[ , ] , as.numeric )

# construct year-specific recodes so that
# &quot;ever smoked a cigarette&quot; // grade // sex // race-ethnicity align across years
y &lt;-
    transform(

        y ,

        smoking = 
            as.numeric(
                ifelse( year == 1991 , q23 ,
                ifelse( year %in% c( 1993 , 2001:2009 ) , q28 ,
                ifelse( year %in% 1995:1997 , q26 ,
                ifelse( year %in% 1999 , q27 ,
                ifelse( year %in% 2011 , q29 , NA ) ) ) ) ) 
            ) ,

        raceeth = 

            ifelse( year %in% 1991:1997 ,
                ifelse( q4 %in% 1:3 , q4 , ifelse( q4 %in% 4:6 , 4 , NA ) ) ,

            ifelse( year %in% 1999:2005 ,
                ifelse( q4 %in% 6 , 1 ,
                ifelse( q4 %in% 3 , 2 ,
                ifelse( q4 %in% c( 4 , 7 ) , 3 ,
                ifelse( q4 %in% c( 1 , 2 , 5 , 8 ) , 4 , NA ) ) ) ) ,

            ifelse( year %in% 2007:2011 ,
                ifelse( raceeth %in% 5 , 1 ,
                ifelse( raceeth %in% 3 , 2 ,
                ifelse( raceeth %in% c( 6 , 7 ) , 3 ,
                ifelse( raceeth %in% c( 1 , 2 , 4 , 8 ) , 4 , NA ) ) ) ) ,

                NA ) ) ) ,

        grade = ifelse( q3 == 5 , NA , as.numeric( q3 ) ) ,

        sex = ifelse( q2 %in% 1:2 , q2 , NA )

    )


# again remove unnecessary variables, keeping only the complex sample survey design columns
# plus independent/dependent variables to be used in the regression analyses
y &lt;- y[ c( &quot;year&quot; , &quot;psu&quot; , &quot;stratum&quot; , &quot;weight&quot; , &quot;smoking&quot; , &quot;raceeth&quot; , &quot;sex&quot; , &quot;grade&quot; ) ]

# set female to the reference group
y$sex &lt;- relevel( factor( y$sex ) , ref = &quot;2&quot; )

# set ever smoked=yes // white // 9th graders as the reference groups
for ( i in c( &#39;smoking&#39; , &#39;raceeth&#39; , &#39;grade&#39; ) ) y[ , i ] &lt;- relevel( factor( y[ , i ] ) , ref = &quot;1&quot; )
</code></pre>

<p>If you&#39;d like more detail about stacking multiple years of complex survey data, review <a href="http://www.cdc.gov/healthyyouth/yrbs/pdf/yrbs_combining_data.pdf">the CDC&#39;s manual</a> on the topic.</p>

<hr/>

<p>&nbsp;  </p>

<h3>(4) Construct a Multi-Year Stacked Complex Survey Design Object</h3>

<p>Before constructing a multi-year stacked design object, check out <code>?contr.poly</code> - this function implements polynomials used in complex survey data.  For more detail on this subject, see <a href="https://www.google.com/search?q=The+polynomials+we+have+used+as+predictors+to+this+point+are+natural+polynomials%2C+generated+from+the+linear+predictor+by+centering+and+the+powering+the+linear+predictor.&amp;ie=utf-8&amp;oe=utf-8">page 216 of Applied Multiple Regression/Correlation Analysis for the Behavioral Sciences</a> By Jacob Cohen, Patricia Cohen, Stephen G. West, Leona S. Aiken <em>&ldquo;The polynomials we have used as predictors to this point are natural polynomials, generated from the linear predictor by centering and the powering the linear predictor.&rdquo;</em></p>

<pre class="language-r"><code class="language-r"># extract a linear contrast vector of length eleven,
# because we have eleven distinct years of yrbss data `seq( 1999 , 2011 , 2 )`
c11l &lt;- contr.poly( 11 )[ , 1 ]

# also extract a quadratic (squared) contrast vector
c11q &lt;- contr.poly( 11 )[ , 2 ]

# just in case, extract a cubic contrast vector
c11c &lt;- contr.poly( 11 )[ , 3 ]

# for each record in the data set, tack on the linear, quadratic, and cubic contrast value
# these contrast values will serve as replacement for the linear `year` variable in any regression.

# year^1 term (linear)
y$t11l &lt;- c11l[ match( y$year , seq( 1999 , 2011 , 2 ) ) ]

# year^2 term (quadratic)
y$t11q &lt;- c11q[ match( y$year , seq( 1999 , 2011 , 2 ) ) ]

# year^3 term (cubic)
y$t11c &lt;- c11c[ match( y$year , seq( 1999 , 2011 , 2 ) ) ]

# construct a complex sample survey design object
# stacking multiple years and accounting for `year` in the nested strata
des &lt;- 
    svydesign(
        id = ~psu , 
        strata = ~interaction( stratum , year ) ,
        data = y , 
        weights = ~weight , 
        nest = TRUE
    )
</code></pre>

<p>Now we&#39;ve got a multi-year stack of complex survey designs with linear, quadratic, and cubic contrast values appended.  Hopefully we won&#39;t need anything beyond cubic, but let&#39;s find out.</p>

<hr/>

<p>&nbsp;<br/>
<strong>Methods note</strong> about how to stack replication designs: This is only relevant if you are trying to create a <code>des</code> like the object above but just have replicate weights and do not have the clustering information (psu).  It is quite straightforward to construct a replication design using a linearized design (see <code>?as.svrepdesign</code>).  However, <a href="http://www.asdfree.com/2014/09/how-to-provide-variance-calculation-on.html">for privacy reasons, going in the opposite direction is much more challenging</a>.  Therefore, you&#39;ll need to do some dataset-specific homework on how to best <em>stack</em> multiple years of a replicate-weighted design you construct a multiple-year-stacked survey design like the object above.</p>

<p>These publicly-available survey data sets include both replicate weights and, separately, clustering information:</p>

<p><a href="http://www.asdfree.com/search/label/medical%20expenditure%20panel%20survey%20%28meps%29">Medical Expenditure Panel Survey</a><br/>
<a href="http://www.asdfree.com/search/label/national%20health%20and%20nutrition%20examination%20survey%20%28nhanes%29">National Health and Nutrition Examination Survey</a><br/>
<a href="http://www.asdfree.com/search/label/consumer%20expenditure%20survey%20%28ce%29">Consumer Expenditure Survey</a>  </p>

<p>In most cases, omitting the <code>year</code> variable from the <code>des</code> construction above will make your standard errors larger (conservative) -&gt; ergo -&gt; you can probably just <code>rbind( repweight_year_one , repweight_year_two , ... )</code> so long as the survey design has not changed over the period.  Once you have the rbound replicate weights object for every year, you could just construct one huge multi-year <code>svrepdesign</code> object. Make sure you include <code>scale</code>, <code>rscales</code>, <code>rho</code>, and whatever else the <code>svrepdesign()</code> call asks for.  If you are worried you missed something, check <code>attributes( your_single_year_replication_design_object )</code>.  This solution is likely all you need in most cases.</p>

<p>If you need to be very conservative with your computation of trend statistical significance: attempt to re-construct fake clusters for yourself using a regression.  Search for &ldquo;malicious&rdquo; in <a href="https://github.com/ajdamico/asdfree/blob/master/Confidentiality/how%20to%20create%20de-identified%20replicate%20weights.R">this confidentiality explanation document</a>.  The purpose here, though, isn&#39;t to identify individual respondents in the dataset, it&#39;s to get a variable like <code>psu</code> above that gives you reasonable standard errors.  Look for the object <code>your.replicate.weights</code> in that script.  You could reconstruct a fake psu for each record in your data set with something as easy as..</p>

<pre class="language-r"><code class="language-r"># fake_psu should be a one-record-per-person vector object
# that can immediately be appended onto your data set.
fake_psu &lt;- kmeans( your.replicate.weights , 20 )
</code></pre>

<p>..where 20 is the (completely made up) number of clusters x strata.  Hopefully the methodology documents (or the people who wrote them) will at least tell you how many clusters there were in the original sample, even if the clusters themselves were not disclosed.  At the point you&#39;ve made fake clusters, they will surely be worse than the real clusters (i.e. conservative standard errors) and you can construct a multiple-year survey design with:</p>

<pre class="language-r"><code class="language-r">des &lt;- svydesign( id = ~ your_fake_psus , strata = ~ year , data = y , weights = ~ weight , nest = TRUE )
</code></pre>

<p>This approach will probably be conservative probably.</p>

<hr/>

<p>&nbsp;  </p>

<h3>(5) Review the unadjusted results</h3>

<p>Here&#39;s the change over time for smoking prevalence among youth. Unadjusted prevalence rates (Figure 1) suggest a significant change in smoking prevalence.</p>

<pre class="language-r"><code class="language-r"># immediately remove records with missing smoking status
des_ns &lt;- subset( des , !is.na( smoking ) )

# calculate unadjusted, un-anythinged &quot;ever smoked&quot; rates by year
# note that this reproduces the unadjusted &quot;ever smoked&quot; statistics at the top of
# pdf page 6 of http://www.cdc.gov/healthyyouth/yrbs/pdf/yrbs_conducting_trend_analyses.pdf
unadjusted &lt;- svyby( ~ smoking , ~ year , svymean , design = des_ns , vartype = c( &#39;ci&#39; , &#39;se&#39; ) )

# coerce that result into a `data.frame` object
my_plot &lt;- data.frame( unadjusted )

# plot the unadjusted decline in smoking
ggplot( my_plot , aes( x = year, y = smoking1 ) ) +
  geom_point() + 
  geom_errorbar( aes( ymax = ci_u.smoking1 , ymin = ci_l.smoking1 ) , width = .2 ) +
  geom_line() +
  theme_tufte() +
  ggtitle( &quot;Figure 1. Unadjusted smoking prevalence 1999-2011&quot; ) +
  theme( plot.title = element_text( size = 9 , face = &quot;bold&quot; ) )
</code></pre>

<p><img src="data:image/png;base64,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" alt="plot of chunk unnamed-chunk-8"/> </p>

<hr/>

<p>&nbsp;  </p>

<h3>(6) Calculate the Number of Joinpoints Needed</h3>

<p>Using the orthogonal coefficients (linear, quadratic, cubic terms) that we previously added to our <code>data.frame</code> object before constructing the multi-year stacked survey design, let&#39;s now determine how many joinpoints will be needed for a trend analysis.</p>

<p>Epidemiological models typically control for possible confounding variables such as sex and race, so let&#39;s add them in with the linear, cubic, and quadratic year terms.</p>

<p>Calculate the &ldquo;ever smoked&rdquo; binomial regression, adjusted by sex, age, race-ethnicity, and a linear year contrast.</p>

<pre class="language-r"><code class="language-r">linyear &lt;- 
    svyglm(
        I( smoking == 1 ) ~ sex + raceeth + grade + t11l , 
        design = subset( des_ns , smoking %in% 1:2 ) , 
        family = quasibinomial
    )

summary( linyear )
</code></pre>

<pre class="r-output"><code class="r-output">## 
## Call:
## svyglm(formula = I(smoking == 1) ~ sex + raceeth + grade + t11l, 
##     design = subset(des_ns, smoking %in% 1:2), family = quasibinomial)
## 
## Survey design:
## subset(des_ns, smoking %in% 1:2)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.41445    0.04563  -9.083  &lt; 2e-16 ***
## sex1        -0.09318    0.02326  -4.005 7.99e-05 ***
## raceeth2    -0.05605    0.04929  -1.137  0.25647    
## raceeth3     0.19022    0.04298   4.426 1.39e-05 ***
## raceeth4    -0.14977    0.05298  -2.827  0.00505 ** 
## grade2       0.26058    0.03134   8.314 4.41e-15 ***
## grade3       0.39964    0.03708  10.779  &lt; 2e-16 ***
## grade4       0.65188    0.03893  16.744  &lt; 2e-16 ***
## t11l        -1.96550    0.11439 -17.183  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for quasibinomial family taken to be 1.002984)
## 
## Number of Fisher Scoring iterations: 4
</code></pre>

<p>The linear year-contrast variable is hugely significant here.  Therefore, there is probably going to be some sort of trend.  A linear trend does not need joinpoints.  Not one, just zero joinpoints.  If the linear term were the only significant term (out of linear, quadratic, cubic..), then we would not need to calculate a joinpoint.  In other words, we would not need to figure out where to best break our time trend into two, three, or even four segments.</p>

<p>Since the linear trend is significant, so we should keep going.</p>

<p>Calculate the &ldquo;ever smoked&rdquo; binomial regression, adjusted by sex, age, race-ethnicity, and both linear and quadratic year contrasts.</p>

<pre class="language-r"><code class="language-r">quadyear &lt;-
    svyglm(
        I( smoking == 1 ) ~ sex + raceeth + grade + t11l + t11q , 
        design = subset( des_ns , smoking %in% 1:2 ) , 
        family = quasibinomial 
    )

summary( quadyear )
</code></pre>

<pre class="r-output"><code class="r-output">## 
## Call:
## svyglm(formula = I(smoking == 1) ~ sex + raceeth + grade + t11l + 
##     t11q, design = subset(des_ns, smoking %in% 1:2), family = quasibinomial)
## 
## Survey design:
## subset(des_ns, smoking %in% 1:2)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.23972    0.07854  -3.052  0.00250 ** 
## sex1        -0.09288    0.02327  -3.991 8.45e-05 ***
## raceeth2    -0.05566    0.04935  -1.128  0.26037    
## raceeth3     0.19094    0.04253   4.489 1.06e-05 ***
## raceeth4    -0.16106    0.05307  -3.035  0.00264 ** 
## grade2       0.26041    0.03139   8.297 5.03e-15 ***
## grade3       0.39890    0.03716  10.736  &lt; 2e-16 ***
## grade4       0.65077    0.03897  16.700  &lt; 2e-16 ***
## t11l        -1.24235    0.28336  -4.384 1.66e-05 ***
## t11q         0.51001    0.19710   2.588  0.01019 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for quasibinomial family taken to be 1.003261)
## 
## Number of Fisher Scoring iterations: 4
</code></pre>

<p>The linear year-contrast variable is hugely significant here but the quadratic year-contrast variable is also significant.  Therefore, we must use joinpoint software for this analysis.  A significant quadratic trend needs one joinpoint.</p>

<p>Since both linear and quadratic terms are significant, we should move ahead and test whether the cubic term is also significant.</p>

<p>Calculate the &ldquo;ever smoked&rdquo; binomial regression, adjusted by sex, age, race-ethnicity, and linear, quadratic, and cubic year contrasts.</p>

<pre class="language-r"><code class="language-r">cubyear &lt;-
    svyglm(
        I( smoking == 1 ) ~ sex + raceeth + grade + t11l + t11q + t11c , 
        design = subset( des_ns , smoking %in% 1:2 ) , 
        family = quasibinomial 
    )

summary( cubyear )
</code></pre>

<pre class="r-output"><code class="r-output">## 
## Call:
## svyglm(formula = I(smoking == 1) ~ sex + raceeth + grade + t11l + 
##     t11q + t11c, design = subset(des_ns, smoking %in% 1:2), family = quasibinomial)
## 
## Survey design:
## subset(des_ns, smoking %in% 1:2)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.28320    0.21756  -1.302  0.19412    
## sex1        -0.09284    0.02325  -3.993 8.41e-05 ***
## raceeth2    -0.05593    0.04944  -1.131  0.25899    
## raceeth3     0.19099    0.04253   4.490 1.05e-05 ***
## raceeth4    -0.16157    0.05350  -3.020  0.00277 ** 
## grade2       0.26036    0.03137   8.299 4.99e-15 ***
## grade3       0.39884    0.03715  10.734  &lt; 2e-16 ***
## grade4       0.65072    0.03897  16.700  &lt; 2e-16 ***
## t11l        -1.43510    0.96744  -1.483  0.13913    
## t11q         0.36885    0.70758   0.521  0.60260    
## t11c        -0.06335    0.31997  -0.198  0.84320    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for quasibinomial family taken to be 1.003279)
## 
## Number of Fisher Scoring iterations: 4
</code></pre>

<p>The cubic year-contrast term is <em>not</em> significant in this model.  Therefore, we should stop testing the shape of this line.  In other words, we can stop at a quadratic trend and <em>do not</em> need a cubic trend.  That means we can stop at a single joinpoint.  Remember: a linear trend requires zero joinpoints, a quadratic trend requires one joinpoint, a cubic trend requires two, and on and on.</p>

<p>Note: if the cubic trend <em>were</em> significant, then we would increase the number of joinpoints to <em>two</em> instead of <em>one</em> but since the cubic term is not significant, we should stop with the previous regression.  If we keep getting significant trends, we ought to continue testing whether higher terms continue to be significant.  So <code>year^4</code> requires three joinpoints, <code>year^5</code> requires four joinpoints, and so on.  If these terms continued to be significant, we would need to return to step #4 and add additional <code>year^n</code> terms to the model.</p>

<p>Just for coherence&#39;s sake, let&#39;s assemble all of these results into a single table where you can see the linear, quadratic, and cubic models side-by-side.  The quadratic trend best describes the relationship between prevalence of smoking and change-over-time. The decision to test beyond linear trends, however, is a decision for the individual researcher to make. It is a decision that can be driven by theoretical issues, existing literature, or the availability of data.
<center></p>

<table cellspacing="0" style="border: none;">
<caption align="bottom" style="margin-top:0.3em;">Table 1. Testing for linear trends</caption>
<tr>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"></th>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"><b>Model 1</b></th>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"><b>Model 2</b></th>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"><b>Model 3</b></th>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">(Intercept)</td>
<td style="padding-right: 12px; border: none;">-0.41 (0.05)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">-0.24 (0.08)<sup style="vertical-align: 0px;">**</sup></td>
<td style="padding-right: 12px; border: none;">-0.28 (0.22)</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">sex1</td>
<td style="padding-right: 12px; border: none;">-0.09 (0.02)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">-0.09 (0.02)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">-0.09 (0.02)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">raceeth2</td>
<td style="padding-right: 12px; border: none;">-0.06 (0.05)</td>
<td style="padding-right: 12px; border: none;">-0.06 (0.05)</td>
<td style="padding-right: 12px; border: none;">-0.06 (0.05)</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">raceeth3</td>
<td style="padding-right: 12px; border: none;">0.19 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.19 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.19 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">raceeth4</td>
<td style="padding-right: 12px; border: none;">-0.15 (0.05)<sup style="vertical-align: 0px;">**</sup></td>
<td style="padding-right: 12px; border: none;">-0.16 (0.05)<sup style="vertical-align: 0px;">**</sup></td>
<td style="padding-right: 12px; border: none;">-0.16 (0.05)<sup style="vertical-align: 0px;">**</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">grade2</td>
<td style="padding-right: 12px; border: none;">0.26 (0.03)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.26 (0.03)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.26 (0.03)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">grade3</td>
<td style="padding-right: 12px; border: none;">0.40 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.40 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.40 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">grade4</td>
<td style="padding-right: 12px; border: none;">0.65 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.65 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.65 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">t11l</td>
<td style="padding-right: 12px; border: none;">-1.97 (0.11)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">-1.24 (0.28)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">-1.44 (0.97)</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">t11q</td>
<td style="padding-right: 12px; border: none;"></td>
<td style="padding-right: 12px; border: none;">0.51 (0.20)<sup style="vertical-align: 0px;">*</sup></td>
<td style="padding-right: 12px; border: none;">0.37 (0.71)</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">t11c</td>
<td style="padding-right: 12px; border: none;"></td>
<td style="padding-right: 12px; border: none;"></td>
<td style="padding-right: 12px; border: none;">-0.06 (0.32)</td>
</tr>
<tr>
<td style="border-top: 1px solid black;">Deviance</td>
<td style="border-top: 1px solid black;">129236.34</td>
<td style="border-top: 1px solid black;">129154.91</td>
<td style="border-top: 1px solid black;">129154.45</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">Dispersion</td>
<td style="padding-right: 12px; border: none;">1.00</td>
<td style="padding-right: 12px; border: none;">1.00</td>
<td style="padding-right: 12px; border: none;">1.00</td>
</tr>
<tr>
<td style="border-bottom: 2px solid black;">Num. obs.</td>
<td style="border-bottom: 2px solid black;">96973</td>
<td style="border-bottom: 2px solid black;">96973</td>
<td style="border-bottom: 2px solid black;">96973</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;" colspan="4"><span style="font-size:0.8em"><sup style="vertical-align: 0px;">***</sup>p &lt; 0.001, <sup style="vertical-align: 0px;">**</sup>p &lt; 0.01, <sup style="vertical-align: 0px;">*</sup>p &lt; 0.05</span></td>
</tr>
</table>

<p></center></p>

<hr/>

<p>&nbsp;  </p>

<h3>(7) Calculate the Adjusted Prevalence and Predicted Marginals</h3>

<p>First, calculate the survey-year-independent predictor effects and store these results into a separate object.</p>

<pre class="language-r"><code class="language-r">marginals &lt;- 
    svyglm(
        formula = I( smoking == 1 ) ~ sex + raceeth + grade ,
        design = des_ns , 
        family = quasibinomial
    )
</code></pre>

<p>Second, run these marginals through the <code>svypredmeans</code> function written by Dr. Thomas Lumley.  For any archaeology fans out there, this function emulates the <code>PREDMARG</code> statement in the ancient language of SUDAAN.</p>

<pre class="language-r"><code class="language-r">( means_for_joinpoint &lt;- svypredmeans( marginals , ~factor( year ) ) )
</code></pre>

<pre class="r-output"><code class="r-output">##         mean     SE
## 2011 0.44204 0.0117
## 2009 0.45981 0.0133
## 2007 0.50443 0.0160
## 2005 0.54455 0.0152
## 2003 0.58499 0.0163
## 2001 0.64415 0.0107
## 1999 0.70705 0.0142
## 1997 0.69934 0.0101
## 1995 0.70731 0.0085
## 1993 0.69080 0.0070
## 1991 0.69968 0.0103
</code></pre>

<p>Finally, clean up these results a bit in preparation for a joinpoint analysis.</p>

<pre class="language-r"><code class="language-r"># coerce the results to a data.frame object
means_for_joinpoint &lt;- as.data.frame( means_for_joinpoint )

# extract the row names as the survey year
means_for_joinpoint$year &lt;- as.numeric( rownames( means_for_joinpoint ) )

# must be sorted, just in case it&#39;s not already
means_for_joinpoint &lt;- means_for_joinpoint[ order( means_for_joinpoint$year ) , ]

# rename columns so they do not conflict with variables in memory
names( means_for_joinpoint ) &lt;- c( &#39;mean&#39; , &#39;se&#39; , &#39;yr&#39; )
# the above line is only because the ?segmented function (used below)
# does not work if an object of the same name is also in memory.
</code></pre>

<p><img src="data:image/png;base64,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" alt="plot of chunk unnamed-chunk-16"/> </p>

<hr/>

<p>&nbsp;  </p>

<h3>(8) Identify the Breakpoint/Changepoint</h3>

<p>The original CDC analysis recommended some <a href="http://surveillance.cancer.gov/joinpoint/">external software from the National Cancer Institute</a>, which only runs on selected platforms. Dr. Vito Muggeo wrote this within R solution using his <a href="https://cran.r-project.org/web/packages/segmented/index.html">segmented</a> package.  Let&#39;s take a look at how confident we are in the value at each adjusted timepoint.  Carrying out a trend analysis requires creating new weights to fit a piecewise linear regression. Figure 3 shows the relationship between variance at each datum and weighting; larger circles are equivalent to a smaller variance and therefore higher weight.</p>

<p><center></p>

<p><img src="data:image/png;base64,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" alt="plot of chunk unnamed-chunk-17"/> </p>

<p></center></p>

<p>First, create that weight variable.</p>

<pre class="language-r"><code class="language-r">means_for_joinpoint$wgt &lt;- with( means_for_joinpoint, ( mean / se ) ^ 2 ) 
</code></pre>

<p>Second, fit a piecewise linear regression.</p>

<pre class="language-r"><code class="language-r"># estimate the &#39;starting&#39; linear model with the usual &quot;lm&quot; function using the log values and the weights.
o &lt;- lm( log( mean ) ~ yr , weights = wgt , data = means_for_joinpoint )
</code></pre>

<p>Now that the regression has been structured correctly, estimate the year that our complex survey trend should be broken.</p>

<pre class="language-r"><code class="language-r"># add a segmented variable (`yr` in this example) with 1 breakpoint
os &lt;- segmented( o , ~yr )

# `os` is now a `segmented` object, which means it includes information on the fitted model,
# such as parameter estimates, standard errors, residuals.
summary( os )
</code></pre>

<pre class="r-output"><code class="r-output">## 
##  ***Regression Model with Segmented Relationship(s)***
## 
## Call: 
## segmented.lm(obj = o, seg.Z = ~yr)
## 
## Estimated Break-Point(s):
##      Est.   St.Err 
## 1998.707    0.386 
## 
## Meaningful coefficients of the linear terms:
##              Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept) -4.827288   4.733316  -1.020    0.342
## yr           0.002241   0.002374   0.944    0.377
## U1.yr       -0.042190   0.002902 -14.538       NA
## 
## Residual standard error: 0.7546 on 7 degrees of freedom
## Multiple R-Squared: 0.9936,  Adjusted R-squared: 0.9908 
## 
## Convergence attained in 2 iterations with relative change -3.256262e-16
</code></pre>

<p>See the <code>Estimated Break-Point(s)</code> in that result?  that&#39;s the critical number from this joinpoint analysis.</p>

<p>Note that the above number is not an integer! The <a href="https://cran.r-project.org/web/packages/segmented/index.html">R <code>segmented</code> package</a> uses an iterative procedure (described in the article below) and therefore between-year solutions are returned.  The joinpoint software implements two estimating algorithms: the grid-search and the Hudson algorithm, the latter returning also non-integer solutions like segmented.  For more detail about this method, see <a href="http://onlinelibrary.wiley.com/doi/10.1002/sim.1545/abstract">Muggeo V. (2003) Estimating regression models with unknown break-points. Statistics in Medicine, 22: 3055-3071.</a>.</p>

<pre class="language-r"><code class="language-r"># figuring out the breakpoint year was the purpose of this joinpoint analysis.
( your_breakpoint &lt;- round( as.vector( os$psi[, &quot;Est.&quot; ] ) ) )
</code></pre>

<pre class="r-output"><code class="r-output">## [1] 1999
</code></pre>

<pre class="language-r"><code class="language-r"># so.  that&#39;s a joinpoint.  that&#39;s where the two line segments join.  okay?

# obtain the annual percent change (APC=) estimates for each time point
slope( os , APC = TRUE )
</code></pre>

<pre class="r-output"><code class="r-output">## $yr
##           Est. CI(95%).l CI(95%).u
## slope1  0.2244   -0.3367    0.7885
## slope2 -3.9160   -4.2950   -3.5360
</code></pre>

<p>The returned CIs for the APC may be different from the ones returned by <a href="surveillance.cancer.gov/joinpoint/">NCI&#39;s Joinpoint Software</a>; for further details, check out <a href="http://onlinelibrary.wiley.com/doi/10.1002/sim.3850/abstract">Muggeo V. (2010) A Comment on Estimating average annual per cent change in trend analysis&#39; by Clegg et al., Statistics in Medicine; 28, 3670-3682. Statistics in Medicine, 29, 1958-1960.</a></p>

<p>This analysis returned similar results to the NCI&#39;s Joinpoint Regression Program by estimating a change point at <code>year=1999</code> - and, more precisely, that the start of that decreasing trend in smoking prevalence happened at an annual percent change (APC) of -3.92 percent.  That is, <code>slope2</code> from the output above.</p>

<hr/>

<p>&nbsp;  </p>

<h3>(9) Make statistically defensible statements about linear trends with complex survey data</h3>

<p>After identifying the change point for smoking prevalence, we can create two regression models.  The first model covers the years leading up to (and including) the change point (i.e., 1991 to 1999).  The second model includes the years from the change point forward (i.e., 1999 to 2011).  So start with 1991, 1993, 1995, 1997, 1999, the five year-points before (and including 1999).</p>

<pre class="language-r"><code class="language-r"># calculate a five-timepoint linear contrast vector
c5l &lt;- contr.poly( 5 )[ , 1 ]

# tack the five-timepoint linear contrast vectors onto the current survey design object
des_ns &lt;- update( des_ns , t5l = c5l[ match( year , seq( 1991 , 1999 , 2 ) ) ] )

pre_91_99 &lt;-
    svyglm(
        I( smoking == 1 ) ~ sex + raceeth + grade + t5l ,
        design = subset( des_ns , smoking %in% 1:2 &amp; year &lt;= 1999 ) , 
        family = quasibinomial
    )

summary( pre_91_99 )
</code></pre>

<pre class="r-output"><code class="r-output">## 
## Call:
## svyglm(formula = I(smoking == 1) ~ sex + raceeth + grade + t5l, 
##     design = subset(des_ns, smoking %in% 1:2 &amp; year &lt;= 1999), 
##     family = quasibinomial)
## 
## Survey design:
## subset(des_ns, smoking %in% 1:2 &amp; year &lt;= 1999)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  0.61609    0.05003  12.314  &lt; 2e-16 ***
## sex1        -0.05856    0.02935  -1.995 0.047310 *  
## raceeth2    -0.12437    0.05412  -2.298 0.022561 *  
## raceeth3     0.18418    0.04781   3.852 0.000156 ***
## raceeth4    -0.16265    0.06497  -2.503 0.013082 *  
## grade2       0.27785    0.04689   5.926 1.29e-08 ***
## grade3       0.36458    0.05606   6.503 5.85e-10 ***
## grade4       0.50805    0.06209   8.183 2.84e-14 ***
## t5l          0.03704    0.05784   0.640 0.522639    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for quasibinomial family taken to be 0.9992789)
## 
## Number of Fisher Scoring iterations: 4
</code></pre>

<p>Reproduce the sentence on <a href="http://www.cdc.gov/healthyyouth/yrbs/pdf/yrbs_conducting_trend_analyses.pdf#page=6">pdf page 6 of the original document</a>.  <strong>In this example, T5L_L had a p-value=0.52261 and beta=0.03704. Therefore, there was &ldquo;no significant change in the prevalence of ever smoking a cigarette during 1991-1999.&rdquo;</strong></p>

<p>Then move on to 1999, 2001, 2003, 2005, 2007, 2009, and 2011, the seven year-points after (and including 1999).</p>

<pre class="language-r"><code class="language-r"># calculate a seven-timepoint linear contrast vector
c7l &lt;- contr.poly( 7 )[ , 1 ]

# tack the seven-timepoint linear contrast vectors onto the current survey design object
des_ns &lt;- update( des_ns , t7l = c7l[ match( year , seq( 1999 , 2011 , 2 ) ) ] )

post_99_11 &lt;-
    svyglm(
        I( smoking == 1 ) ~ sex + raceeth + grade + t7l ,
        design = subset( des_ns , smoking %in% 1:2 &amp; year &gt;= 1999 ) , 
        family = quasibinomial
    )

summary( post_99_11 )
</code></pre>

<pre class="r-output"><code class="r-output">## 
## Call:
## svyglm(formula = I(smoking == 1) ~ sex + raceeth + grade + t7l, 
##     design = subset(des_ns, smoking %in% 1:2 &amp; year &gt;= 1999), 
##     family = quasibinomial)
## 
## Survey design:
## subset(des_ns, smoking %in% 1:2 &amp; year &gt;= 1999)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.03964    0.04287  -0.925  0.35595    
## sex1        -0.09318    0.02326  -4.005 7.99e-05 ***
## raceeth2    -0.05605    0.04929  -1.137  0.25647    
## raceeth3     0.19022    0.04298   4.426 1.39e-05 ***
## raceeth4    -0.14977    0.05298  -2.827  0.00505 ** 
## grade2       0.26058    0.03134   8.314 4.41e-15 ***
## grade3       0.39964    0.03708  10.779  &lt; 2e-16 ***
## grade4       0.65188    0.03893  16.744  &lt; 2e-16 ***
## t7l         -0.99165    0.05771 -17.183  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for quasibinomial family taken to be 1.000677)
## 
## Number of Fisher Scoring iterations: 4
</code></pre>

<p>Reproduce the sentence on <a href="http://www.cdc.gov/healthyyouth/yrbs/pdf/yrbs_conducting_trend_analyses.pdf#page=6">pdf page 6 of the original document</a>.  <strong>In this example, T7L_R had a p-value&lt;0.0001 and beta=-0.99165. Therefore, there was a &ldquo;significant linear decrease in the prevalence of ever smoking a cigarette during 1999-2011.&rdquo;</strong></p>

<p>Note also that the 1999-2011 time period saw a linear decrease, which supports the APC estimate in step #8.  Here&#39;s everything displayed as a single coherent table.</p>

<p><center></p>

<table cellspacing="0" style="border: none;">
<caption align="bottom" style="margin-top:0.3em;">Table 2. Linear trends pre-post changepoint</caption>
<tr>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"></th>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"><b>Model 1</b></th>
<th style="text-align: left; border-top: 2px solid black; border-bottom: 1px solid black; padding-right: 12px;"><b>Model 2</b></th>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">(Intercept)</td>
<td style="padding-right: 12px; border: none;">0.62 (0.05)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">-0.04 (0.04)</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">sex1</td>
<td style="padding-right: 12px; border: none;">-0.06 (0.03)<sup style="vertical-align: 0px;">*</sup></td>
<td style="padding-right: 12px; border: none;">-0.09 (0.02)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">raceeth2</td>
<td style="padding-right: 12px; border: none;">-0.12 (0.05)<sup style="vertical-align: 0px;">*</sup></td>
<td style="padding-right: 12px; border: none;">-0.06 (0.05)</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">raceeth3</td>
<td style="padding-right: 12px; border: none;">0.18 (0.05)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.19 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">raceeth4</td>
<td style="padding-right: 12px; border: none;">-0.16 (0.06)<sup style="vertical-align: 0px;">*</sup></td>
<td style="padding-right: 12px; border: none;">-0.15 (0.05)<sup style="vertical-align: 0px;">**</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">grade2</td>
<td style="padding-right: 12px; border: none;">0.28 (0.05)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.26 (0.03)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">grade3</td>
<td style="padding-right: 12px; border: none;">0.36 (0.06)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.40 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">grade4</td>
<td style="padding-right: 12px; border: none;">0.51 (0.06)<sup style="vertical-align: 0px;">***</sup></td>
<td style="padding-right: 12px; border: none;">0.65 (0.04)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">t5l</td>
<td style="padding-right: 12px; border: none;">0.04 (0.06)</td>
<td style="padding-right: 12px; border: none;"></td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">t7l</td>
<td style="padding-right: 12px; border: none;"></td>
<td style="padding-right: 12px; border: none;">-0.99 (0.06)<sup style="vertical-align: 0px;">***</sup></td>
</tr>
<tr>
<td style="border-top: 1px solid black;">Deviance</td>
<td style="border-top: 1px solid black;">83192.21</td>
<td style="border-top: 1px solid black;">128939.00</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;">Dispersion</td>
<td style="padding-right: 12px; border: none;">1.00</td>
<td style="padding-right: 12px; border: none;">1.00</td>
</tr>
<tr>
<td style="border-bottom: 2px solid black;">Num. obs.</td>
<td style="border-bottom: 2px solid black;">68769</td>
<td style="border-bottom: 2px solid black;">96973</td>
</tr>
<tr>
<td style="padding-right: 12px; border: none;" colspan="3"><span style="font-size:0.8em"><sup style="vertical-align: 0px;">***</sup>p &lt; 0.001, <sup style="vertical-align: 0px;">**</sup>p &lt; 0.01, <sup style="vertical-align: 0px;">*</sup>p &lt; 0.05</span></td>
</tr>
</table>
 

<p></center></p>

<hr/>

<p>&nbsp;  </p>

<h3>Thanks</h3>

<p>This analysis may complement qualitative evaluation on prevalence changes observed from surveillance data by providing quantitative evidence, such as when a change point occurred. This analysis does not explain why or how changes in trends occur.</p>

</body>

</html>
